<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üß¨ Dual-Syringe AI-Optimized Bioprinting Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }

        /* (Keep all your existing CSS styles here) */
        /* ... */

        /* 3D Preview Container */
        .preview-container {
            width: 100%;
            height: 300px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        .preview-container canvas {
            display: block;
        }

        .preview-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .preview-controls button {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preview-controls button:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        /* (Keep all other existing styles) */
        /* ... */

    </style>
</head>
<body>
    <!-- (Keep all your existing HTML structure) -->
    <!-- ... -->

    <!-- 3D Preview Section -->
    <div class="preview-3d">
        <h3>üîç 3D Tissue Preview</h3>
        <div class="preview-container" id="previewContainer">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #667eea;">
                Click "Generate 3D Preview" to begin
            </div>
        </div>
        <div class="preview-controls" id="previewControls" style="display: none;">
            <button onclick="rotateModel('left')">‚Üª Rotate Left</button>
            <button onclick="rotateModel('right')">‚Ü∫ Rotate Right</button>
            <button onclick="zoomModel('in')">+ Zoom In</button>
            <button onclick="zoomModel('out')">- Zoom Out</button>
        </div>
        <button class="start-print-btn" onclick="init3DPreview()">Generate 3D Preview</button>
    </div>

    <!-- (Keep the rest of your HTML) -->
    <!-- ... -->

    <!-- Add Three.js library -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>

    <script>
        // (Keep all your existing JavaScript)
        // ...

        // 3D Preview Variables
        let scene, camera, renderer, controls;
        let tissueModel = null;
        let is3DPreviewActive = false;

        function init3DPreview() {
            const container = document.getElementById('previewContainer');
            const previewControls = document.getElementById('previewControls');
            
            if (is3DPreviewActive) {
                // Reset if already active
                container.innerHTML = '';
                previewControls.style.display = 'none';
                is3DPreviewActive = false;
                container.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #667eea;">Click "Generate 3D Preview" to begin</div>';
                return;
            }

            container.innerHTML = '';
            previewControls.style.display = 'flex';
            is3DPreviewActive = true;

            // Get current settings for visualization
            const tissueType = document.getElementById('tissueType1').value || 'generic';
            const isDual = document.getElementById('syringe2Panel').style.opacity === '1';
            const bioink1 = document.getElementById('bioink1').value || 'default';
            const bioink2 = isDual ? document.getElementById('bioink2').value : null;

            // Initialize Three.js scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f0f23);
            
            // Setup camera
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 5;
            
            // Setup renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            
            // Create tissue model based on current settings
            createTissueModel(tissueType, isDual, bioink1, bioink2);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation loop
            animate();
        }

        function createTissueModel(tissueType, isDual, bioink1, bioink2) {
            // Clear previous model if exists
            if (tissueModel) {
                scene.remove(tissueModel);
            }
            
            // Create a group to hold all tissue components
            tissueModel = new THREE.Group();
            
            // Base tissue structure (varies by tissue type)
            let geometry, material;
            
            switch(tissueType.toLowerCase()) {
                case 'bone':
                    geometry = new THREE.BoxGeometry(2, 2, 0.5);
                    material = new THREE.MeshPhongMaterial({ 
                        color: 0xf0e68c,
                        transparent: true,
                        opacity: 0.8
                    });
                    break;
                case 'cartilage':
                    geometry = new THREE.SphereGeometry(1, 32, 32);
                    material = new THREE.MeshPhongMaterial({ 
                        color: 0x98fb98,
                        transparent: true,
                        opacity: 0.7
                    });
                    break;
                case 'skin':
                    geometry = new THREE.PlaneGeometry(2, 2);
                    material = new THREE.MeshPhongMaterial({ 
                        color: 0xffdbac,
                        side: THREE.DoubleSide
                    });
                    break;
                case 'liver':
                    geometry = new THREE.DodecahedronGeometry(1, 0);
                    material = new THREE.MeshPhongMaterial({ 
                        color: 0xb22222,
                        transparent: true,
                        opacity: 0.8
                    });
                    break;
                case 'heart':
                    geometry = new THREE.TorusKnotGeometry(0.8, 0.3, 100, 16);
                    material = new THREE.MeshPhongMaterial({ 
                        color: 0xff6347,
                        transparent: true,
                        opacity: 0.8
                    });
                    break;
                default:
                    geometry = new THREE.SphereGeometry(1, 32, 32);
                    material = new THREE.MeshPhongMaterial({ 
                        color: 0x9370db,
                        transparent: true,
                        opacity: 0.8
                    });
            }
            
            const baseTissue = new THREE.Mesh(geometry, material);
            tissueModel.add(baseTissue);
            
            // Add cellular material if dual syringe
            if (isDual && bioink2) {
                let cellularGeometry, cellularMaterial;
                
                switch(bioink2.toLowerCase()) {
                    case 'cell-laden collagen':
                        cellularGeometry = new THREE.SphereGeometry(0.2, 16, 16);
                        cellularMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                        // Add multiple cell clusters
                        for (let i = 0; i < 50; i++) {
                            const cell = new THREE.Mesh(cellularGeometry, cellularMaterial);
                            cell.position.set(
                                (Math.random() - 0.5) * 2,
                                (Math.random() - 0.5) * 2,
                                (Math.random() - 0.5) * 2
                            );
                            tissueModel.add(cell);
                        }
                        break;
                    case 'vascular alginate':
                        // Create vascular network
                        const vascularMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
                        for (let i = 0; i < 10; i++) {
                            const vascularGeometry = new THREE.CylinderGeometry(0.05, 0.05, 1.5, 8);
                            const vessel = new THREE.Mesh(vascularGeometry, vascularMaterial);
                            vessel.rotation.x = Math.random() * Math.PI;
                            vessel.rotation.y = Math.random() * Math.PI;
                            tissueModel.add(vessel);
                        }
                        break;
                    case 'growth factor gel':
                        // Add growth factor particles
                        const gfGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                        const gfMaterial = new THREE.MeshPhongMaterial({ color: 0xffff00 });
                        for (let i = 0; i < 30; i++) {
                            const gf = new THREE.Mesh(gfGeometry, gfMaterial);
                            gf.position.set(
                                (Math.random() - 0.5) * 1.5,
                                (Math.random() - 0.5) * 1.5,
                                (Math.random() - 0.5) * 1.5
                            );
                            tissueModel.add(gf);
                        }
                        break;
                }
            }
            
            scene.add(tissueModel);
        }

        function onWindowResize() {
            const container = document.getElementById('previewContainer');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function animate() {
            if (!is3DPreviewActive) return;
            
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function rotateModel(direction) {
            if (!tissueModel) return;
            tissueModel.rotation.y += direction === 'left' ? 0.1 : -0.1;
        }

        function zoomModel(action) {
            if (!camera) return;
            camera.position.z += action === 'in' ? -0.5 : 0.5;
        }

        // (Keep all your other existing JavaScript functions)
        // ...
    </script>
</body>
</html>
